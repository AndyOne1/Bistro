<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bistro Kasse</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Icons
    const Settings = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"></path>
      </svg>
    );
    const Calendar = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );
    const X = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );
    const Plus = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );
    const Trash2 = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );
    const Undo = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M3 7v6h6"></path>
        <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"></path>
      </svg>
    );
    const Pencil = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M12 20h9"></path>
        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
      </svg>
    );
    const Check = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M20 6L9 17l-5-5"></path>
      </svg>
    );
    const Shield = () => (
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
      </svg>
    );

    const CATEGORIES = ["Getränke", "Snacks", "Eis"];
    const CATEGORY_STYLES = {
      Getränke: { button: "bg-blue-500 hover:bg-blue-600", badge: "bg-blue-50 text-blue-700 border-blue-200" },
      Snacks:  { button: "bg-amber-500 hover:bg-amber-600", badge: "bg-amber-50 text-amber-800 border-amber-200" },
      Eis:     { button: "bg-fuchsia-500 hover:bg-fuchsia-600", badge: "bg-fuchsia-50 text-fuchsia-800 border-fuchsia-200" },
    };

    // Templates (morgen ersetzen wir items)
    const INVENTORY_TEMPLATES = [
      {
        id: "demo_template_v1",
        name: "Test-Template (Demo)",
        description: "Beispiel-Inventar für Start/Tests (kann morgen ersetzt werden).",
        items: [
          { name: "Wasser", price: 1.00, category: "Getränke" },
          { name: "Cola", price: 1.50, category: "Getränke" },
          { name: "Kaffee", price: 1.20, category: "Getränke" },
          { name: "Chips", price: 1.20, category: "Snacks" },
          { name: "Schokoriegel", price: 0.90, category: "Snacks" },
          { name: "Eis am Stiel", price: 1.20, category: "Eis" },
        ],
      },
    ];

    const normalizeCategory = (cat) => (cat && CATEGORIES.includes(cat)) ? cat : "Getränke";
    const asMoney = (n) => (Number(n) || 0).toFixed(2);

    const slugify = (s) =>
      String(s || "")
        .toLowerCase()
        .trim()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-äöüß]/g, "")
        .slice(0, 64);

    const templateItemId = (templateId, item) => `tpl:${templateId}:${normalizeCategory(item.category)}:${slugify(item.name)}`;

    const api = {
      async request(path, { method="GET", token=null, body=null } = {}) {
        const headers = { "Content-Type": "application/json" };
        if (token) headers["Authorization"] = `Bearer ${token}`;
        const res = await fetch(`/.netlify/functions/${path}`, {
          method,
          headers,
          body: body ? JSON.stringify(body) : null,
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || `Request failed (${res.status})`);
        return data;
      },
      groups() { return this.request("groups"); },
      loginGroup(payload) { return this.request("login-group", { method: "POST", body: payload }); },
      loginAdmin(payload) { return this.request("login-admin", { method: "POST", body: payload }); },
      createGroup(token, payload) { return this.request("groups", { method: "POST", token, body: payload }); },
      changeAdminPassword(token, payload) { return this.request("admin-password", { method: "POST", token, body: payload }); },
      getDayReports(token) { return this.request("day-reports", { token }); },
      createDayReport(token, payload) { return this.request("day-reports", { method: "POST", token, body: payload }); },
      deleteDayReport(token, id) { return this.request(`day-reports?id=${encodeURIComponent(id)}`, { method: "DELETE", token }); },
    };

    const LoginScreen = ({ onLogin }) => {
      const [groups, setGroups] = useState([]);
      const [mode, setMode] = useState("user"); // user | admin
      const [groupId, setGroupId] = useState("");
      const [name, setName] = useState("");
      const [password, setPassword] = useState("");
      const [error, setError] = useState("");
      const [loading, setLoading] = useState(false);

      useEffect(() => {
        (async () => {
          try {
            const data = await api.groups();
            setGroups(data.groups || []);
            if ((data.groups || []).length) setGroupId(data.groups[0].id);
          } catch (e) {
            setError("Konnte Gruppen nicht laden. (Netlify Functions/DB prüfen)");
          }
        })();
      }, []);

      const submit = async () => {
        setError("");
        setLoading(true);
        try {
          if (mode === "admin") {
            const data = await api.loginAdmin({ password });
            onLogin({ token: data.token, role: data.role, name: data.name, groupName: data.groupName });
          } else {
            if (!name.trim()) throw new Error("Name ist Pflicht.");
            const data = await api.loginGroup({ groupId, password, name: name.trim() });
            onLogin({ token: data.token, role: data.role, name: data.name, groupName: data.groupName });
          }
        } catch (e) {
          setError(e.message || "Login fehlgeschlagen");
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gray-50 p-4 flex items-center justify-center">
          <div className="bg-white shadow-lg rounded-xl w-full max-w-md p-6">
            <h1 className="text-2xl font-bold text-gray-800 mb-2">Bistro Kasse</h1>
            <p className="text-sm text-gray-600 mb-6">Bitte anmelden, um fortzufahren.</p>

            <div className="flex gap-2 mb-4">
              <button
                onClick={() => setMode("user")}
                className={`flex-1 py-2 rounded-lg font-semibold border ${mode==="user" ? "bg-blue-600 text-white border-blue-600" : "bg-white text-gray-700"}`}
              >
                Nutzer
              </button>
              <button
                onClick={() => setMode("admin")}
                className={`flex-1 py-2 rounded-lg font-semibold border ${mode==="admin" ? "bg-gray-800 text-white border-gray-800" : "bg-white text-gray-700"}`}
              >
                Admin
              </button>
            </div>

            {mode === "user" && (
              <>
                <label className="text-sm font-semibold text-gray-700">Gruppe</label>
                <select
                  value={groupId}
                  onChange={(e) => setGroupId(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg mb-3 bg-white"
                >
                  {groups.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                </select>

                <label className="text-sm font-semibold text-gray-700">Dein Name (Pflicht)</label>
                <input
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg mb-3"
                  placeholder="z. B. Max"
                />
              </>
            )}

            <label className="text-sm font-semibold text-gray-700">
              {mode === "admin" ? "Admin Passwort" : "Gruppenpasswort"}
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-4 py-2 border rounded-lg mb-4"
              placeholder="Passwort"
            />

            {error && <div className="mb-4 p-3 rounded-lg bg-red-50 text-red-700 text-sm border border-red-200">{error}</div>}

            <button
              onClick={submit}
              disabled={loading || !password || (mode==="user" && (!groupId || !name.trim()))}
              className="w-full py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-300"
            >
              {loading ? "..." : "Anmelden"}
            </button>

            <p className="text-xs text-gray-400 mt-4">
              Hinweis: Tagesabschlüsse werden zentral gespeichert. Artikel/Inventar bleiben pro Gerät lokal.
            </p>
          </div>
        </div>
      );
    };

    const BistroKasse = () => {
      // Session
      const [session, setSession] = useState(null); // {token, role, name, groupName}
      const isAdmin = session?.role === "admin";

      // App state
      const [articles, setArticles] = useState([]);
      const [currentTransaction, setCurrentTransaction] = useState([]);

      const [showSettings, setShowSettings] = useState(false);
      const [showPayment, setShowPayment] = useState(false);
      const [showDayReport, setShowDayReport] = useState(false);
      const [showAdminPanel, setShowAdminPanel] = useState(false);

      const [givenAmount, setGivenAmount] = useState(0);

      // dailySales keyed by item id
      const [dailySales, setDailySales] = useState({});

      // DB day reports
      const [remoteReports, setRemoteReports] = useState([]);
      const [reportsError, setReportsError] = useState("");

      // Articles CRUD (Admin only)
      const [newArticle, setNewArticle] = useState({ name: "", price: "", category: "Getränke" });
      const [editingId, setEditingId] = useState(null);
      const [editDraft, setEditDraft] = useState({ name: "", price: "", category: "Getränke" });

      // Templates
      const [activeTemplateId, setActiveTemplateId] = useState(localStorage.getItem("bistro-active-template-id") || null);
      const [templateSelection, setTemplateSelection] = useState(INVENTORY_TEMPLATES[0]?.id || "");

      // Admin: groups + admin password change
      const [groups, setGroups] = useState([]);
      const [newGroup, setNewGroup] = useState({ name: "", password: "" });
      const [adminPw, setAdminPw] = useState({ current: "", next: "" });
      const [adminMsg, setAdminMsg] = useState("");

      // Load session
      useEffect(() => {
        const raw = localStorage.getItem("bistro-session");
        if (raw) {
          try { setSession(JSON.parse(raw)); } catch {}
        }
      }, []);

      const onLogin = (s) => {
        localStorage.setItem("bistro-session", JSON.stringify(s));
        setSession(s);
      };

      const logout = () => {
        localStorage.removeItem("bistro-session");
        setSession(null);
      };

      // Load local articles (per device) once logged in
      useEffect(() => {
        if (!session) return;
        const savedArticles = localStorage.getItem("bistro-articles");
        if (savedArticles) {
          try { setArticles(JSON.parse(savedArticles)); } catch {}
        }
      }, [session]);

      useEffect(() => {
        if (!session) return;
        localStorage.setItem("bistro-articles", JSON.stringify(articles));
      }, [articles, session]);

      useEffect(() => {
        if (!session) return;
        localStorage.setItem("bistro-active-template-id", activeTemplateId || "");
      }, [activeTemplateId, session]);

      const pfandInItem = useMemo(() => ({ id: "pfand_in", name: "Pfand Einnahme", price: 0.25, category: "Pfand" }), []);
      const pfandOutItem = useMemo(() => ({ id: "pfand_out", name: "Pfand Ausgabe", price: -0.25, category: "Pfand" }), []);

      const categorizedArticles = useMemo(() => {
        const grouped = CATEGORIES.reduce((acc, cat) => (acc[cat] = [], acc), {});
        for (const a of articles) {
          const cat = normalizeCategory(a.category);
          grouped[cat].push(a);
        }
        return grouped;
      }, [articles]);

      const getTemplateById = (id) => INVENTORY_TEMPLATES.find(t => t.id === id) || null;

      const applyTemplate = (templateId) => {
        const tpl = getTemplateById(templateId);
        if (!tpl) return;

        setArticles((prev) => {
          const existingKey = new Set(prev.map((a) => `${normalizeCategory(a.category)}|${a.name}`));
          const additions = [];

          for (const item of tpl.items) {
            const name = (item.name || "").trim();
            const price = Number(item.price);
            const category = normalizeCategory(item.category);
            if (!name || Number.isNaN(price)) continue;

            const key = `${category}|${name}`;
            if (existingKey.has(key)) continue;

            additions.push({ id: templateItemId(tpl.id, { name, category }), name, price, category });
            existingKey.add(key);
          }
          return additions.length ? [...prev, ...additions] : prev;
        });
      };

      const activateTemplate = (templateId) => {
        setActiveTemplateId(templateId);
        applyTemplate(templateId);
      };

      const deactivateTemplate = () => setActiveTemplateId(null);

      // Transaction
      const addToTransaction = (item) => {
        setCurrentTransaction((prev) => [...prev, item]);

        setDailySales((prev) => {
          const next = { ...prev };
          const key = item.id || `legacy-${item.name}`;
          if (!next[key]) next[key] = { id: key, name: item.name, count: 0, revenue: 0 };
          next[key].name = item.name;
          next[key].count += 1;
          next[key].revenue += item.price;
          return next;
        });
      };

      const undoLastItem = () => {
        setCurrentTransaction((prev) => {
          if (!prev.length) return prev;
          const last = prev[prev.length - 1];

          setDailySales((salesPrev) => {
            const next = { ...salesPrev };
            const key = last.id || `legacy-${last.name}`;
            if (next[key]) {
              next[key].count -= 1;
              next[key].revenue -= last.price;
              if (next[key].count <= 0) delete next[key];
            }
            return next;
          });

          return prev.slice(0, -1);
        });
      };

      const calculateTotal = () => currentTransaction.reduce((sum, item) => sum + item.price, 0);

      const clearTransaction = () => {
        if (!currentTransaction.length) return;

        setDailySales((salesPrev) => {
          const next = { ...salesPrev };
          for (const item of currentTransaction) {
            const key = item.id || `legacy-${item.name}`;
            if (!next[key]) continue;
            next[key].count -= 1;
            next[key].revenue -= item.price;
            if (next[key].count <= 0) delete next[key];
          }
          return next;
        });

        setCurrentTransaction([]);
        setGivenAmount(0);
      };

      // Admin-only CRUD
      const handleAddArticle = () => {
        if (!isAdmin) return;
        if (!newArticle.name || !newArticle.price) return;
        const price = parseFloat(newArticle.price);
        if (Number.isNaN(price)) return;

        const article = {
          id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
          name: newArticle.name.trim(),
          price,
          category: normalizeCategory(newArticle.category),
        };
        if (!article.name) return;

        setArticles((prev) => [...prev, article]);
        setNewArticle({ name: "", price: "", category: "Getränke" });
      };

      const handleDeleteArticle = (id) => {
        if (!isAdmin) return;
        setArticles((prev) => prev.filter((a) => a.id !== id));
      };

      const startEdit = (article) => {
        if (!isAdmin) return;
        setEditingId(article.id);
        setEditDraft({ name: article.name, price: String(article.price), category: normalizeCategory(article.category) });
      };

      const cancelEdit = () => {
        setEditingId(null);
        setEditDraft({ name: "", price: "", category: "Getränke" });
      };

      const saveEdit = () => {
        if (!isAdmin || !editingId) return;
        const price = parseFloat(editDraft.price);
        if (!editDraft.name.trim() || Number.isNaN(price)) return;

        setArticles((prev) =>
          prev.map((a) =>
            a.id === editingId
              ? { ...a, name: editDraft.name.trim(), price, category: normalizeCategory(editDraft.category) }
              : a
          )
        );
        cancelEdit();
      };

      // Payment
      const addToGivenAmount = (amount) => setGivenAmount((prev) => prev + amount);
      const calculateChange = () => givenAmount - calculateTotal();
      const completeTransaction = () => {
        setCurrentTransaction([]);
        setGivenAmount(0);
        setShowPayment(false);
      };

      // Stats
      const getDayStats = () => {
        let pfandIn = 0, pfandOut = 0, merchandise = 0;
        Object.values(dailySales).forEach((data) => {
          if (data.id === "pfand_in" || data.name === "Pfand Einnahme") pfandIn += data.revenue;
          else if (data.id === "pfand_out" || data.name === "Pfand Ausgabe") pfandOut += data.revenue;
          else merchandise += data.revenue;
        });
        return { pfandIn, pfandOut, pfandBalance: pfandIn + pfandOut, merchandise, total: pfandIn + pfandOut + merchandise };
      };
      const stats = getDayStats();

      // DB: load reports
      const refreshReports = async () => {
        setReportsError("");
        try {
          const data = await api.getDayReports(session.token);
          setRemoteReports(data.reports || []);
        } catch (e) {
          setReportsError(e.message || "Konnte Tagesabschlüsse nicht laden.");
        }
      };

      useEffect(() => {
        if (!session) return;
        refreshReports();
      }, [session]);

      const closeDay = async () => {
        const today = new Date().toLocaleDateString("de-DE");
        const totalRevenue = Object.values(dailySales).reduce((sum, item) => sum + item.revenue, 0);

        try {
          await api.createDayReport(session.token, {
            day_label: today,
            total_revenue: totalRevenue,
            sales_json: dailySales,
          });
          setDailySales({});
          await refreshReports();
        } catch (e) {
          alert(e.message || "Speichern fehlgeschlagen");
        }
      };

      const deleteReport = async (id) => {
        if (!isAdmin) return;
        const ok = window.confirm("Diesen Tagesabschluss wirklich löschen?");
        if (!ok) return;
        try {
          await api.deleteDayReport(session.token, id);
          await refreshReports();
        } catch (e) {
          alert(e.message || "Löschen fehlgeschlagen");
        }
      };

      // Admin panel: groups and admin pw
      const loadGroups = async () => {
        try {
          const data = await api.groups();
          setGroups(data.groups || []);
        } catch {}
      };

      useEffect(() => {
        if (!session) return;
        loadGroups();
      }, [session]);

      const createGroup = async () => {
        setAdminMsg("");
        try {
          await api.createGroup(session.token, { name: newGroup.name.trim(), password: newGroup.password });
          setNewGroup({ name: "", password: "" });
          setAdminMsg("Gruppe angelegt.");
          await loadGroups();
        } catch (e) {
          setAdminMsg(e.message || "Fehler");
        }
      };

      const changeAdminPassword = async () => {
        setAdminMsg("");
        try {
          await api.changeAdminPassword(session.token, { currentPassword: adminPw.current, newPassword: adminPw.next });
          setAdminPw({ current: "", next: "" });
          setAdminMsg("Admin Passwort geändert.");
        } catch (e) {
          setAdminMsg(e.message || "Fehler");
        }
      };

      if (!session) return <LoginScreen onLogin={onLogin} />;

      const bottomPanelHeightClass = "h-72";
      const bottomPaddingClass = "pb-80";

      return (
        <div className={`min-h-screen bg-gray-50 p-4 ${bottomPaddingClass}`}>
          <div className="max-w-7xl mx-auto mb-6">
            <div className="flex justify-between items-center">
              <div>
                <h1 className="text-3xl font-bold text-gray-800">Bistro Kasse</h1>
                <div className="text-sm text-gray-500 mt-1">
                  Angemeldet als <span className="font-semibold text-gray-700">{session.name}</span>
                  {" "}({session.groupName}) – <span className="font-semibold">{isAdmin ? "Admin" : "Nutzer"}</span>
                  {" "}· <button className="underline text-gray-500 hover:text-gray-700" onClick={logout}>Logout</button>
                </div>
              </div>

              <div className="flex gap-2">
                <button
                  onClick={() => { setShowDayReport(true); refreshReports(); }}
                  className="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                  title="Tagesabschluss"
                >
                  <Calendar />
                </button>

                {isAdmin && (
                  <button
                    onClick={() => setShowAdminPanel(true)}
                    className="p-2 bg-gray-900 text-white rounded-lg hover:bg-black transition"
                    title="Admin"
                  >
                    <Shield />
                  </button>
                )}

                <button
                  onClick={() => setShowSettings(true)}
                  className="p-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition"
                  title="Einstellungen"
                >
                  <Settings />
                </button>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-lg shadow-md p-6">
              <h2 className="text-xl font-semibold mb-4 text-gray-700">Artikel</h2>

              <div className="mb-6">
                <h3 className="text-sm font-bold uppercase tracking-wide text-gray-500 mb-2">Pfand</h3>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                  <button
                    onClick={() => addToTransaction({ ...pfandInItem })}
                    className="p-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-semibold"
                  >
                    Pfand Einnahme<br />+0,25€
                  </button>
                  <button
                    onClick={() => addToTransaction({ ...pfandOutItem })}
                    className="p-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold"
                  >
                    Pfand Ausgabe<br />-0,25€
                  </button>
                </div>
              </div>

              <div className="space-y-6">
                {CATEGORIES.map((cat) => {
                  const styles = CATEGORY_STYLES[cat];
                  return (
                    <div key={cat}>
                      <div className="flex items-center justify-between mb-2">
                        <div className={`inline-flex items-center gap-2 px-3 py-1 rounded-full border text-sm font-semibold ${styles.badge}`}>
                          {cat}
                        </div>
                        <span className="text-xs text-gray-400">{(categorizedArticles[cat] || []).length} Artikel</span>
                      </div>

                      {(categorizedArticles[cat] || []).length === 0 ? (
                        <div className="p-4 bg-gray-50 rounded-lg text-gray-400 text-sm">
                          Keine Artikel in dieser Kategorie
                        </div>
                      ) : (
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                          {categorizedArticles[cat].map((article) => (
                            <button
                              key={article.id}
                              onClick={() => addToTransaction(article)}
                              className={`p-4 text-white rounded-lg transition font-semibold ${styles.button}`}
                            >
                              {article.name}<br />
                              {article.price > 0 ? "+" : ""}{asMoney(article.price)}€
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* Fixed bottom transaction panel */}
          <div className="fixed left-0 right-0 bottom-0 z-40 p-3">
            <div className="max-w-7xl mx-auto">
              <div className={`bg-white rounded-xl shadow-2xl border ${bottomPanelHeightClass} overflow-hidden`}>
                <div className="h-full flex flex-col">
                  <div className="px-4 py-3 border-b flex items-center justify-between">
                    <h2 className="text-lg font-semibold text-gray-700">Aktueller Vorgang</h2>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={undoLastItem}
                        disabled={currentTransaction.length === 0}
                        className="p-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
                        title="Letzten Eintrag rückgängig machen"
                      >
                        <Undo />
                      </button>
                      <button
                        onClick={clearTransaction}
                        disabled={currentTransaction.length === 0}
                        className="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                        title="Vorgang leeren (inkl. Zählung rückgängig)"
                      >
                        Leeren
                      </button>
                    </div>
                  </div>

                  <div className="flex-1 overflow-y-auto px-4 py-2">
                    {currentTransaction.length === 0 ? (
                      <p className="text-gray-400 text-center py-8">Keine Artikel</p>
                    ) : (
                      currentTransaction.map((item, index) => (
                        <div key={`${item.id || item.name}-${index}`} className="flex justify-between py-2 border-b">
                          <span className="text-gray-700">{item.name}</span>
                          <span className={`font-semibold ${item.price >= 0 ? "text-green-600" : "text-red-600"}`}>
                            {item.price > 0 ? "+" : ""}{asMoney(item.price)}€
                          </span>
                        </div>
                      ))
                    )}
                  </div>

                  <div className="px-4 py-3 border-t bg-white">
                    <div className="flex items-center justify-between mb-3">
                      <span className="text-lg font-bold text-gray-800">Gesamt:</span>
                      <span className="text-2xl font-bold text-blue-600">{asMoney(calculateTotal())}€</span>
                    </div>
                    <button
                      onClick={() => setShowPayment(true)}
                      disabled={currentTransaction.length === 0}
                      className="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                      Zur Bezahlung
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Settings modal: Templates always visible; Articles only for admin */}
          {showSettings && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto p-6">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-gray-800">Einstellungen</h2>
                  <button onClick={() => setShowSettings(false)} className="text-gray-500 hover:text-gray-700">
                    <X />
                  </button>
                </div>

                {/* Templates */}
                <div className="mb-8 p-4 rounded-lg border bg-gray-50">
                  <h3 className="text-lg font-semibold mb-2 text-gray-700">Inventar-Templates</h3>
                  <p className="text-sm text-gray-600 mb-4">
                    Nutzer können nur Templates aktivieren. Artikelpflege ist nur für Admin.
                  </p>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-2 items-start">
                    <select
                      value={templateSelection}
                      onChange={(e) => setTemplateSelection(e.target.value)}
                      className="md:col-span-2 w-full px-4 py-2 border rounded-lg bg-white"
                    >
                      {INVENTORY_TEMPLATES.map((t) => (
                        <option key={t.id} value={t.id}>{t.name}</option>
                      ))}
                    </select>

                    <div className="flex md:flex-col gap-2">
                      <button
                        onClick={() => activateTemplate(templateSelection)}
                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition"
                      >
                        Aktivieren
                      </button>
                      <button
                        onClick={() => applyTemplate(activeTemplateId || templateSelection)}
                        className="flex-1 px-4 py-2 bg-white border rounded-lg font-semibold hover:bg-gray-100 transition"
                      >
                        Erneut anwenden
                      </button>
                      <button
                        onClick={deactivateTemplate}
                        className="flex-1 px-4 py-2 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition disabled:opacity-50"
                        disabled={!activeTemplateId}
                      >
                        Deaktivieren
                      </button>
                    </div>
                  </div>

                  <div className="mt-4 text-sm">
                    <div className="flex items-center justify-between p-3 bg-white rounded-lg border">
                      <span className="text-gray-700 font-medium">Aktives Template:</span>
                      <span className={`font-semibold ${activeTemplateId ? "text-green-700" : "text-gray-500"}`}>
                        {activeTemplateId ? (getTemplateById(activeTemplateId)?.name || activeTemplateId) : "Keins"}
                      </span>
                    </div>
                    {templateSelection && (
                      <div className="mt-2 text-gray-600">
                        {getTemplateById(templateSelection)?.description || ""}
                      </div>
                    )}
                  </div>
                </div>

                {/* Admin-only Article CRUD */}
                {!isAdmin ? (
                  <div className="p-4 rounded-lg bg-amber-50 border border-amber-200 text-amber-900 text-sm">
                    Artikelpflege ist nur für Admin freigeschaltet.
                  </div>
                ) : (
                  <>
                    <div className="mb-6">
                      <h3 className="text-lg font-semibold mb-3 text-gray-700">Neuer Artikel (Admin)</h3>
                      <div className="flex flex-col md:flex-row gap-2">
                        <input
                          type="text"
                          placeholder="Name"
                          value={newArticle.name}
                          onChange={(e) => setNewArticle({ ...newArticle, name: e.target.value })}
                          className="flex-1 px-4 py-2 border rounded-lg"
                        />
                        <input
                          type="number"
                          step="0.01"
                          placeholder="Preis (€)"
                          value={newArticle.price}
                          onChange={(e) => setNewArticle({ ...newArticle, price: e.target.value })}
                          className="w-full md:w-32 px-4 py-2 border rounded-lg"
                        />
                        <select
                          value={newArticle.category}
                          onChange={(e) => setNewArticle({ ...newArticle, category: e.target.value })}
                          className="w-full md:w-40 px-4 py-2 border rounded-lg bg-white"
                        >
                          {CATEGORIES.map((cat) => <option key={cat} value={cat}>{cat}</option>)}
                        </select>
                        <button onClick={handleAddArticle} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                          <Plus />
                        </button>
                      </div>
                    </div>

                    <div>
                      <h3 className="text-lg font-semibold mb-3 text-gray-700">Vorhandene Artikel (Admin)</h3>
                      <div className="space-y-2">
                        {articles.map((article) => {
                          const isEditing = editingId === article.id;
                          const badge = CATEGORY_STYLES[normalizeCategory(article.category)]?.badge || "bg-gray-50 text-gray-700 border-gray-200";
                          return (
                            <div key={article.id} className="p-3 bg-gray-50 rounded-lg">
                              {!isEditing ? (
                                <div className="flex justify-between items-center gap-3">
                                  <div className="min-w-0">
                                    <div className="font-medium text-gray-700 truncate">{article.name}</div>
                                    <div className="mt-1 flex items-center gap-2">
                                      <span className={`text-xs px-2 py-0.5 rounded-full border ${badge}`}>
                                        {normalizeCategory(article.category)}
                                      </span>
                                      <span className="text-blue-600 font-semibold">{asMoney(article.price)}€</span>
                                    </div>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <button onClick={() => startEdit(article)} className="px-3 py-2 bg-white border rounded-lg hover:bg-gray-100 transition">
                                      <Pencil />
                                    </button>
                                    <button onClick={() => handleDeleteArticle(article.id)} className="px-3 py-2 bg-white border rounded-lg hover:bg-red-50 text-red-600 transition">
                                      <Trash2 />
                                    </button>
                                  </div>
                                </div>
                              ) : (
                                <div className="space-y-3">
                                  <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    <input
                                      type="text"
                                      value={editDraft.name}
                                      onChange={(e) => setEditDraft({ ...editDraft, name: e.target.value })}
                                      className="px-4 py-2 border rounded-lg"
                                    />
                                    <input
                                      type="number"
                                      step="0.01"
                                      value={editDraft.price}
                                      onChange={(e) => setEditDraft({ ...editDraft, price: e.target.value })}
                                      className="px-4 py-2 border rounded-lg"
                                    />
                                    <select
                                      value={editDraft.category}
                                      onChange={(e) => setEditDraft({ ...editDraft, category: e.target.value })}
                                      className="px-4 py-2 border rounded-lg bg-white"
                                    >
                                      {CATEGORIES.map((cat) => <option key={cat} value={cat}>{cat}</option>)}
                                    </select>
                                  </div>
                                  <div className="flex gap-2">
                                    <button onClick={saveEdit} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition inline-flex items-center gap-2">
                                      <Check /> Speichern
                                    </button>
                                    <button onClick={cancelEdit} className="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition inline-flex items-center gap-2">
                                      <X /> Abbrechen
                                    </button>
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                        {articles.length === 0 && <p className="text-gray-400 text-center py-6">Noch keine Artikel angelegt</p>}
                      </div>
                    </div>
                  </>
                )}
              </div>
            </div>
          )}

          {/* Admin Panel */}
          {showAdminPanel && isAdmin && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto p-6">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-gray-800">Admin</h2>
                  <button onClick={() => setShowAdminPanel(false)} className="text-gray-500 hover:text-gray-700">
                    <X />
                  </button>
                </div>

                {adminMsg && (
                  <div className="mb-4 p-3 rounded-lg bg-blue-50 text-blue-800 border border-blue-200 text-sm">
                    {adminMsg}
                  </div>
                )}

                <div className="mb-8 p-4 rounded-lg border bg-gray-50">
                  <h3 className="text-lg font-semibold mb-3 text-gray-700">Neue Gruppe anlegen</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <input
                      className="px-4 py-2 border rounded-lg"
                      placeholder="Gruppenname (z. B. 4a Dienst)"
                      value={newGroup.name}
                      onChange={(e) => setNewGroup({ ...newGroup, name: e.target.value })}
                    />
                    <input
                      className="px-4 py-2 border rounded-lg"
                      type="password"
                      placeholder="Gruppenpasswort"
                      value={newGroup.password}
                      onChange={(e) => setNewGroup({ ...newGroup, password: e.target.value })}
                    />
                  </div>
                  <button
                    onClick={createGroup}
                    className="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
                    disabled={!newGroup.name.trim() || newGroup.password.length < 6}
                  >
                    Gruppe erstellen
                  </button>

                  <div className="mt-4">
                    <div className="text-sm font-semibold text-gray-700 mb-2">Vorhandene Gruppen</div>
                    <div className="space-y-2">
                      {groups.map(g => (
                        <div key={g.id} className="p-3 bg-white border rounded-lg flex justify-between">
                          <span className="font-medium text-gray-700">{g.name}</span>
                          <span className="text-xs text-gray-400">{g.id}</span>
                        </div>
                      ))}
                      {groups.length === 0 && <div className="text-sm text-gray-400">Keine Gruppen vorhanden</div>}
                    </div>
                  </div>
                </div>

                <div className="p-4 rounded-lg border bg-gray-50">
                  <h3 className="text-lg font-semibold mb-3 text-gray-700">Admin Passwort ändern</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <input
                      className="px-4 py-2 border rounded-lg"
                      type="password"
                      placeholder="Aktuelles Passwort"
                      value={adminPw.current}
                      onChange={(e) => setAdminPw({ ...adminPw, current: e.target.value })}
                    />
                    <input
                      className="px-4 py-2 border rounded-lg"
                      type="password"
                      placeholder="Neues Passwort (min. 8)"
                      value={adminPw.next}
                      onChange={(e) => setAdminPw({ ...adminPw, next: e.target.value })}
                    />
                  </div>
                  <button
                    onClick={changeAdminPassword}
                    className="mt-3 px-4 py-2 bg-gray-900 text-white rounded-lg font-semibold hover:bg-black transition"
                    disabled={adminPw.next.length < 8 || !adminPw.current}
                  >
                    Passwort ändern
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Payment modal */}
          {showPayment && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg max-w-md w-full p-6">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-gray-800">Bezahlung</h2>
                  <button onClick={() => { setShowPayment(false); setGivenAmount(0); }} className="text-gray-500 hover:text-gray-700">
                    <X />
                  </button>
                </div>

                <div className="mb-6">
                  <div className="bg-gray-100 p-4 rounded-lg mb-4">
                    <p className="text-gray-600 text-sm">Zu bezahlen:</p>
                    <p className="text-3xl font-bold text-gray-800">{asMoney(calculateTotal())}€</p>
                  </div>

                  <div className="bg-blue-50 p-4 rounded-lg mb-4">
                    <p className="text-gray-600 text-sm">Gegeben:</p>
                    <p className="text-2xl font-bold text-blue-600">{asMoney(givenAmount)}€</p>
                  </div>

                  <div className={`p-4 rounded-lg mb-4 ${calculateChange() >= 0 ? "bg-green-50" : "bg-red-50"}`}>
                    <p className="text-gray-600 text-sm">Rückgeld:</p>
                    <p className={`text-2xl font-bold ${calculateChange() >= 0 ? "text-green-600" : "text-red-600"}`}>
                      {asMoney(calculateChange())}€
                    </p>
                  </div>
                </div>

                <div className="grid grid-cols-5 gap-2 mb-4">
                  {[1,2,3,4,5,6,7,8,9,10].map((amount) => (
                    <button
                      key={amount}
                      onClick={() => addToGivenAmount(amount)}
                      className="p-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold transition"
                    >
                      {amount}€
                    </button>
                  ))}
                </div>

                <input
                  type="number"
                  step="0.01"
                  value={givenAmount}
                  onChange={(e) => setGivenAmount(parseFloat(e.target.value) || 0)}
                  placeholder="Oder Betrag eingeben..."
                  className="w-full px-4 py-3 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                />

                <div className="flex gap-2">
                  <button
                    onClick={() => setGivenAmount(0)}
                    className="flex-1 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition"
                  >
                    Zurücksetzen
                  </button>
                  <button
                    onClick={completeTransaction}
                    disabled={calculateChange() < 0}
                    className="flex-1 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
                  >
                    Abschließen
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Day report modal (uses DB) */}
          {showDayReport && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg max-w-3xl w-full max-h-[80vh] overflow-y-auto p-6">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-gray-800">Tagesabschluss</h2>
                  <button onClick={() => setShowDayReport(false)} className="text-gray-500 hover:text-gray-700">
                    <X />
                  </button>
                </div>

                <div className="mb-8 p-6 bg-blue-50 rounded-lg">
                  <h3 className="text-xl font-bold mb-2 text-gray-800">Heutiger Tag</h3>
                  <p className="text-sm text-gray-600 mb-4">
                    Einreichung wird gespeichert als: <span className="font-semibold">{session.name}</span> ({session.groupName})
                  </p>

                  <div className="mb-4">
                    <h4 className="font-semibold text-gray-700 mb-2">Verkaufte Artikel:</h4>
                    <div className="space-y-1">
                      {Object.values(dailySales).map((data) => (
                        <div key={data.id} className="flex justify-between text-gray-600">
                          <span>{data.name}:</span>
                          <span className="font-semibold">{data.count}x</span>
                        </div>
                      ))}
                      {Object.keys(dailySales).length === 0 && (
                        <p className="text-gray-400 text-center py-4">Noch keine Verkäufe heute</p>
                      )}
                    </div>
                  </div>

                  <div className="border-t pt-4 space-y-2">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Pfand Einnahmen:</span>
                      <span className="font-semibold text-green-600">+{asMoney(stats.pfandIn)}€</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Pfand Ausgaben:</span>
                      <span className="font-semibold text-red-600">{asMoney(stats.pfandOut)}€</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Pfand Bilanz:</span>
                      <span className={`font-semibold ${stats.pfandBalance >= 0 ? "text-green-600" : "text-red-600"}`}>
                        {asMoney(stats.pfandBalance)}€
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Warenverkauf:</span>
                      <span className="font-semibold text-blue-600">{asMoney(stats.merchandise)}€</span>
                    </div>
                    <div className="flex justify-between pt-2 border-t-2">
                      <span className="text-xl font-bold text-gray-800">Gesamteinnahmen:</span>
                      <span className="text-2xl font-bold text-blue-600">{asMoney(stats.total)}€</span>
                    </div>
                  </div>

                  <button
                    onClick={closeDay}
                    disabled={Object.keys(dailySales).length === 0}
                    className="w-full mt-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
                  >
                    Tag abschließen (speichern)
                  </button>
                </div>

                <div>
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-bold text-gray-800">Archiv (alle Gruppen)</h3>
                    <button
                      onClick={refreshReports}
                      className="px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300 transition"
                    >
                      Aktualisieren
                    </button>
                  </div>

                  {reportsError && (
                    <div className="mb-4 p-3 rounded-lg bg-red-50 text-red-700 text-sm border border-red-200">
                      {reportsError}
                    </div>
                  )}

                  {remoteReports.length === 0 ? (
                    <p className="text-gray-400 text-center py-8">Noch keine abgeschlossenen Tage</p>
                  ) : (
                    <div className="space-y-4">
                      {remoteReports.map((day) => (
                        <div key={day.id} className="p-4 bg-gray-50 rounded-lg">
                          <div className="flex justify-between items-center mb-2 gap-3">
                            <div>
                              <h4 className="font-bold text-gray-800">{day.day_label}</h4>
                              <div className="text-xs text-gray-500">
                                Eingereicht von: <span className="font-semibold">{day.submitted_by}</span> ({day.group_name})
                              </div>
                            </div>

                            <div className="flex items-center gap-3">
                              <span className="text-lg font-bold text-blue-600">{asMoney(day.total_revenue)}€</span>
                              {isAdmin && (
                                <button
                                  onClick={() => deleteReport(day.id)}
                                  className="px-3 py-2 bg-white border rounded-lg hover:bg-red-50 text-red-600 transition"
                                  title="Diesen Tag löschen (Admin)"
                                >
                                  <Trash2 />
                                </button>
                              )}
                            </div>
                          </div>

                          <div className="text-sm space-y-1">
                            {day.sales_json && Object.values(day.sales_json).map((data) => (
                              <div key={data.id || data.name} className="flex justify-between text-gray-600">
                                <span>{data.name}:</span>
                                <span>{data.count}x ({asMoney(data.revenue)}€)</span>
                              </div>
                            ))}
                          </div>

                          <div className="text-xs text-gray-400 mt-2">
                            Zeit: {new Date(day.created_at).toLocaleString("de-DE")}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<BistroKasse />);
  </script>
</body>
</html>
